events {
    worker_connections 1024;
}

http {
    upstream backend_up {
        server backend:8000;
    }
    upstream frontend {
        server frontend:80;
    }

    resolver 127.0.0.11 valid=10s;

    # Админка — порт 3000 (localhost only, SSH-туннель)
    # ВАЖНО: /admin идёт ТОЛЬКО во frontend SPA, НИКОГДА в backend
    server {
        listen 3000;
        server_name localhost 127.0.0.1 _;
        client_max_body_size 500M;

        set $fe "http://frontend:80";

        # Корень -> редирект в админку
        location = / {
            return 301 /admin;
        }

        # API только в backend ( /api/health -> backend /health, /api/v1/... -> backend /v1/... )
        location ^~ /api/ {
            proxy_pass http://backend_up/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # /admin -> /admin/ (SPA)
        location = /admin {
            return 301 /admin/;
        }

        location ^~ /admin/ {
            proxy_pass $fe;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # SPA assets — явно, чтобы отдавался JS/CSS, а не index.html
        location ^~ /assets/ {
            # Через переменную, чтобы DNS frontend пересчитывался и не было 502 после пересборки контейнера
            proxy_pass $fe;
            proxy_set_header Host $host;
        }

        location ^~ /b24 {
            proxy_pass $fe;
            proxy_set_header Host $host;
        }

        location / {
            proxy_pass $fe/;
            proxy_set_header Host $host;
        }
    }

    # Публичные Bitrix endpoints — слушает 8080, сюда проксирует host nginx
    server {
        listen 8080;
        server_name _;
        client_max_body_size 500M;

        location /health {
            proxy_pass http://backend_up/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /ready {
            proxy_pass http://backend_up/ready;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /v1/bitrix/ {
            proxy_pass http://backend_up/v1/bitrix/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 60s;
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
        }

        # public iframe UI
        location ^~ /iframe/ {
            proxy_pass http://frontend/iframe/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /api/version {
            proxy_pass http://backend_up/health;
            proxy_set_header Host $host;
        }
    }
}
