# Установка Teachbase AI в Bitrix24 Cloud

**Bitrix24 Cloud, локальное приложение (серверное).** Не «Управление сайтом».

Источник: [Bitrix24 REST API — Local Applications](https://apidocs.bitrix24.com/local-integrations/local-apps.html)

---

## Форма «Локальное приложение»

В Bitrix24: **Приложения → Ресурсы разработчика → Другое → Локальное приложение (серверное)**.

### Куда что вставлять

| Поле в форме Bitrix24 | Значение |
|-----------------------|----------|
| **Путь вашего обработчика** | `https://necrogame.ru/api/v1/bitrix/handler` |
| **Путь для первоначальной установки** | `https://necrogame.ru/api/v1/bitrix/install` |

### Per-portal credentials (local.*)

На каждом портале Bitrix24 генерирует **уникальные** `client_id` (вида `local.*`) и `client_secret`. Они **НЕ** из env — хранятся в БД per-portal, шифрованно. В env только `TOKEN_ENCRYPTION_KEY` и инфраструктура.

Если после установки в админке видите **missing_client_credentials**:
- Откройте админку → Порталы → портал → **Bitrix OAuth (локальное приложение)**.
- Введите `client_id/client_secret` для этого портала и нажмите **Сохранить**.
- Нажмите **Test refresh** и повторите bot-check/fix-handlers/ping.

### Права (scope)

- **imbot** — чат-боты
- **im** — мессенджер
- **placement** — встраивание
- **user** — получение списка сотрудников (обязательно для выбора allowlist при установке)

Без права **user** список сотрудников при установке не загрузится (0 из 0). Права **crm** для текущего сценария не нужны.

---

## Установка на первый портал

1. **Ресурсы разработчика → Локальное приложение (серверное)**.
2. Вставьте URL:
   - Handler: `https://necrogame.ru/api/v1/bitrix/handler`
   - Install: `https://necrogame.ru/api/v1/bitrix/install`
3. Права: **imbot, im, placement, user**.
4. Сохраните и нажмите **Установить приложение**.
5. Откроется iframe с установкой. Страница получит auth через BX24 SDK, сохранит токены, затем загрузит список сотрудников (если есть право user).
6. Выберите сотрудников, которым разрешён чат с ботом, и нажмите **Установить приложение**.
7. Создайте бота и привяжите к приложению. Зарегистрируйте ONIMBOTMESSAGEADD через event.bind (если Bitrix не сделает сам).

### Если Bitrix не передал AUTH_ID

Установочная страница сама получает auth через BX24 SDK в браузере. Отдельно «переустанавливать» не нужно: откройте приложение — страница установки подтянет токены и завершит настройку.

---

## Установка на второй портал

1. На втором портале откройте **Ресурсы разработчика → Локальное приложение**.
2. Введите те же URL (handler и install).
3. Установите приложение.
4. У каждого портала будет свой `portal_id` и свои токены в БД.

---

## Проверка ping/pong

1. Откройте чат с ботом (только выбранные при установке сотрудники имеют доступ).
2. Напишите **ping** → бот отвечает **pong**.
3. Любой другой текст → ответ **ок**.

Сообщения от пользователей, не входящих в allowlist, не обрабатываются (событие blocked_by_acl, в админке — раздел событий/трейсы).

---

## Админка и трейсы

1. **SSH-туннель** (если локально 3000 занят — используйте 33000):
   - `ssh -L 33000:127.0.0.1:3000 root@109.73.193.61`
2. Браузер: http://127.0.0.1:33000/admin (или :3000 если свободен)
3. Разделы: **Порталы**, **Диалоги**, **Трейсы Bitrix**, **Система**.

В **Трейсы Bitrix** виден полный trace: inbound (install/handler/events) и outbound (REST). Фильтр по `portal_id` и `trace_id`.

---

## Типовые ошибки

| Симптом | Действие |
|---------|----------|
| В iframe виден сырой JSON от install/complete | Раньше это был баг (document navigation на /install/complete). Сейчас исправлено: такой запрос получает 303 редирект на /install; установка идёт через fetch из install.html, в iframe всегда HTML с выбором пользователей. |
| События не приходят | Проверить event.bind, scope imbot |
| 429 | Снизить частоту запросов |
| Токен истёк | attempt-fix в админке или переустановка |
| missing_client_credentials | В админке заполнить per-portal client_id/client_secret |
| Очередь растёт | Проверить worker, логи |
| 502 | Проверить /health, контейнеры |
