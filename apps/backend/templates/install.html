<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Teachbase AI — Установка</title>
  <script src="https://unpkg.com/@bitrix24/b24jssdk@latest/dist/umd/index.min.js"></script>
  <style>
    :root {
      --ink: #0f172a;
      --muted: #64748b;
      --accent: #2563eb;
      --bg: #f3f6ff;
      --card: #ffffff;
      --border: #e2e8f0;
      --shadow: 0 16px 36px rgba(15, 23, 42, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Manrope', 'Inter', system-ui, -apple-system, Segoe UI, sans-serif;
      color: var(--ink);
      background: radial-gradient(circle at 10% 10%, #f2f7ff 0%, #f8fbff 45%, #ffffff 100%);
      user-select: none;
    }
    input, textarea { user-select: text; }
    .wrap {
      max-width: 1120px;
      margin: 0 auto;
      padding: 32px 20px 48px;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 24px;
    }
    .title {
      font-size: 32px;
      margin: 0 0 10px;
    }
    .subtitle {
      margin: 0 0 18px;
      color: var(--muted);
      font-size: 14px;
    }
    .pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.8);
      color: var(--accent);
      font-size: 12px;
      font-weight: 600;
      box-shadow: var(--shadow);
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-top: 18px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .card h3 {
      margin: 0 0 6px;
      font-size: 14px;
    }
    .card p {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }
    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 20px;
      box-shadow: var(--shadow);
    }
    .panel h2 {
      margin: 0 0 6px;
      font-size: 18px;
    }
    .panel .info {
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 14px;
    }
    .status {
      background: #e8f0ff;
      color: #1e3a8a;
      border: 1px solid #c8d9f4;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      margin-bottom: 12px;
    }
    .search {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #f8fbff;
      font-size: 13px;
      margin-bottom: 10px;
    }
    #user-list {
      max-height: 280px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px 10px;
      background: #fbfdff;
    }
    .user-row {
      padding: 8px 6px;
      border-bottom: 1px solid #edf2ff;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    .user-row:last-child { border-bottom: none; }
    .actions {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .btn {
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      background: var(--accent);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-secondary {
      background: #e2e8f0;
      color: #1f2937;
    }
    .muted {
      color: var(--muted);
      font-size: 12px;
    }
    #install-steps {
      margin-top: 14px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px dashed #d9e2f6;
      padding: 10px 12px;
      font-size: 12px;
    }
    @media (max-width: 980px) {
      .wrap { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div>
      <div class="pill">Teachbase AI · Установка</div>
      <h1 class="title">Запустите свой AI‑кабинет</h1>
      <p class="subtitle">Регистрация без Bitrix24. Получите доступ к базе знаний, конструкторам и настройкам ботов.</p>
      <div class="cards">
        <div class="card">
          <h3>База знаний</h3>
          <p>Файлы, URL‑источники, индексация.</p>
        </div>
        <div class="card">
          <h3>Конструктор бота</h3>
          <p>Готовые сценарии и тестовый прогон.</p>
        </div>
        <div class="card">
          <h3>Интеграции</h3>
          <p>Bitrix24, webhook и будущие каналы.</p>
        </div>
        <div class="card">
          <h3>Оплата</h3>
          <p>Гибкие тарифы и контроль расходов.</p>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>Подключение сотрудников</h2>
      <div class="info">Выберите сотрудников, которым разрешён чат с ботом.</div>
      <div id="status" class="status">Загрузка Bitrix24...</div>
      <div id="step-users" style="display:none;">
        <input type="search" id="user-search" class="search" placeholder="Поиск по имени..." />
        <div id="user-list"></div>
        <div class="actions">
          <label class="muted"><input type="checkbox" id="select-all" /> Выбрать всех</label>
          <span id="count-msg" class="muted">Выбрано: 0</span>
        </div>
        <div class="actions">
          <button id="btn-install" class="btn" disabled>Установить приложение</button>
          <button id="btn-retry" class="btn btn-secondary" style="display:none;">Повторить шаг 2</button>
        </div>
        <div id="install-steps" style="display:none;">
          <div id="step-allowlist">Шаг 1: Доступ сохранён — ожидание</div>
          <div id="step-bot">Шаг 2: Чат создан — ожидание</div>
          <div id="step-ping">Шаг 3: Ping/pong — ожидание</div>
          <div id="users-status" style="margin-top:0.5rem;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
(function() {
  const base = window.location.origin;
  const status = document.getElementById('status');
  const stepUsers = document.getElementById('step-users');
  const userList = document.getElementById('user-list');
  const userSearch = document.getElementById('user-search');
  const selectAll = document.getElementById('select-all');
  const countMsg = document.getElementById('count-msg');
  const btnInstall = document.getElementById('btn-install');
  const btnRetry = document.getElementById('btn-retry');

  function setStatus(text) {
    status.textContent = text;
  }

  function setStepUsers(show) {
    stepUsers.style.display = show ? 'block' : 'none';
  }

  let b24Instance = null;

  function callInstallFinish() {
    return new Promise(function(resolve, reject) {
      if (b24Instance && typeof b24Instance.installFinish === 'function') {
        try { b24Instance.installFinish(); return resolve(); } catch (e) { return reject(e); }
      }
      if (b24Instance && b24Instance.app && typeof b24Instance.app.installFinish === 'function') {
        try { b24Instance.app.installFinish(); return resolve(); } catch (e) { return reject(e); }
      }
      if (window.BX24 && typeof window.BX24.init === 'function') {
        try {
          window.BX24.init(function() {
            if (typeof window.BX24.installFinish === 'function') {
              try { window.BX24.installFinish(); return resolve(); } catch (e) { return reject(e); }
            }
            return reject(new Error('Метод BX24.installFinish недоступен. Обновите страницу в Bitrix24.'));
          });
          return;
        } catch (e) { return reject(e); }
      }
      if (window.BX24 && typeof window.BX24.installFinish === 'function') {
        try { window.BX24.installFinish(); return resolve(); } catch (e) { return reject(e); }
      }
      return reject(new Error('Не удалось завершить установку: нет доступного BX24.installFinish. Обновите страницу в Bitrix24.'));
    });
  }

  let portalToken = '';
  let portalId = 0;
  let authData = null;
  let allUsers = [];
  let accessUserIds = new Set();

  function renderUsers(filter) {
    const q = (filter || '').toLowerCase();
    const filtered = q
      ? allUsers.filter(function(u) {
          const name = ((u.name || '') + ' ' + (u.last_name || '') + ' ' + (u.email || '')).toLowerCase();
          return name.indexOf(q) !== -1;
        })
      : allUsers;
    userList.innerHTML = filtered.map(function(u) {
      const name = (u.name || '') + ' ' + (u.last_name || '').trim() || u.email || 'ID ' + u.id;
      const checked = accessUserIds.has(String(u.id)) ? ' checked' : '';
      return '<div class="user-row"><label><input type="checkbox" class="user-cb" data-id="' + u.id + '"' + checked + ' /> ' + escapeHtml(name) + '</label></div>';
    }).join('');
    userList.querySelectorAll('.user-cb').forEach(function(cb) {
      cb.addEventListener('change', updateCount);
    });
    updateCount();
  }

  function getUserIdFromAuth(authData) {
    if (!authData) return null;
    const v = authData.user_id || authData.USER_ID || authData.userId || authData.USERID;
    if (v == null || v === '') return null;
    const n = parseInt(v, 10);
    return Number.isFinite(n) ? n : null;
  }

  function fetchCurrentUserId($b24, authData) {
    return new Promise(function(resolve) {
      const fromAuth = getUserIdFromAuth(authData);
      if (fromAuth) return resolve(fromAuth);
      const caller = ($b24 && typeof $b24.callMethod === 'function') ? $b24 : (window.BX24 && typeof window.BX24.callMethod === 'function' ? window.BX24 : null);
      if (!caller) return resolve(null);
      try {
        caller.callMethod('user.current', {}, function(res) {
          try {
            const data = res && (typeof res.data === 'function' ? res.data() : res.data);
            const id = data && (data.ID || data.id);
            const n = parseInt(id, 10);
            return resolve(Number.isFinite(n) ? n : null);
          } catch (e) { return resolve(null); }
        });
      } catch (e) { return resolve(null); }
    });
  }

  function escapeHtml(s) {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  function updateCount() {
    const n = userList.querySelectorAll('.user-cb:checked').length;
    countMsg.textContent = 'Выбрано: ' + n;
    btnInstall.disabled = n === 0;
    selectAll.checked = n > 0 && n === userList.querySelectorAll('.user-cb').length;
  }

  selectAll.addEventListener('change', function() {
    userList.querySelectorAll('.user-cb').forEach(function(cb) {
      cb.checked = selectAll.checked;
    });
    updateCount();
  });

  userSearch.addEventListener('input', function() {
    renderUsers(userSearch.value);
  });

  function setStepText(id, text, ok) {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = text;
    el.style.color = ok ? '#15803d' : (ok === false ? '#b91c1c' : 'inherit');
  }

  function renderUserStatuses(failed, baseUrl) {
    const box = document.getElementById('users-status');
    if (!box) return;
    baseUrl = baseUrl || base;
    if (!failed || failed.length === 0) {
      box.textContent = 'Все пользователи: ok';
      box.style.color = '#15803d';
      return;
    }
    box.innerHTML = '';
    box.style.color = '#b91c1c';
    box.appendChild(document.createTextNode('Ошибки: '));
    failed.forEach(function(f, i) {
      if (i > 0) box.appendChild(document.createTextNode('; '));
      const line = 'user_id ' + f.user_id + ': ' + (f.bitrix_error_code || f.code || 'error') +
        (f.bitrix_error_desc ? ' — ' + f.bitrix_error_desc : '');
      if (f.trace_id_child) {
        const a = document.createElement('a');
        a.href = baseUrl + '/admin/traces/' + f.trace_id_child;
        a.textContent = line + ' (trace: ' + f.trace_id_child + ')';
        a.target = '_blank';
        a.rel = 'noopener';
        a.className = 'muted';
        box.appendChild(a);
      } else {
        box.appendChild(document.createTextNode(line));
      }
    });
  }

  function getTraceIdFromResponse(r, data) {
    if (data && data.trace_id) return data.trace_id;
    var h = r.headers.get('X-Trace-Id');
    if (h) return h.trim();
    return '';
  }

  function parseJsonOrThrow(r) {
    var ct = (r.headers.get('Content-Type') || '').toLowerCase();
    if (ct.indexOf('application/json') >= 0) return r.json();
    return r.text().then(function(t){ throw new Error(t || 'unexpected response'); });
  }

  function apiPost(path, body) {
    return fetch(base + '/api/v1/bitrix' + path, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
      body: JSON.stringify(body || {})
    });
  }

  function apiGet(path) {
    return fetch(base + '/api/v1/bitrix' + path, {
      method: 'GET',
      headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
    });
  }

  function installStepComplete(selectedIds) {
    const payload = { user_ids: selectedIds, auth: authData };
    return apiPost('/install/complete', payload).then(function(r) {
      return parseJsonOrThrow(r).then(function(data){ return { r: r, data: data }; });
    });
  }

  function finalizeProvision(selectedIds) {
    return apiPost('/app/provision', { auth: authData }).then(function(r) {
      return parseJsonOrThrow(r).then(function(data){ return { r: r, data: data }; });
    });
  }

  function loadUsers() {
    return fetch(base + '/api/v1/bitrix/users?portal_id=' + portalId + '&limit=200', {
      method: 'GET',
      headers: { 'Accept': 'application/json', 'Authorization': 'Bearer ' + portalToken, 'X-Requested-With': 'XMLHttpRequest' }
    }).then(function(r) { return parseJsonOrThrow(r); });
  }

  function loadAccessUsers() {
    return fetch(base + '/api/v1/bitrix/portals/' + portalId + '/access/users', {
      method: 'GET',
      headers: { 'Accept': 'application/json', 'Authorization': 'Bearer ' + portalToken, 'X-Requested-With': 'XMLHttpRequest' }
    }).then(function(r) { return parseJsonOrThrow(r); });
  }

  function saveAccessUsers(ids) {
    return fetch(base + '/api/v1/bitrix/portals/' + portalId + '/access/users', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', 'Authorization': 'Bearer ' + portalToken, 'X-Requested-With': 'XMLHttpRequest' },
      body: JSON.stringify({ user_ids: ids })
    });
  }

  function initWithBx24($b24) {
    if (!$b24) { setStatus('BX24 SDK не доступен'); return; }
    b24Instance = $b24;
    if ($b24.auth && typeof $b24.auth.getAuthData === 'function') {
      const auth = $b24.auth.getAuthData() || {};
      authData = auth;
      setStatus('Получение списка сотрудников...');
      apiPost('/session/start', { auth: authData }).then(function(r){ return parseJsonOrThrow(r); })
        .then(function(session) {
          portalToken = session.portal_token;
          portalId = session.portal_id;
          return Promise.all([loadUsers(), loadAccessUsers()]);
        })
        .then(function(all) {
          const usersResp = all[0] || {};
          const accessResp = all[1] || {};
          allUsers = usersResp.users || [];
          accessUserIds = new Set((accessResp.user_ids || []).map(function(id){ return String(id); }));
          setStepUsers(true);
          renderUsers('');
          setStatus('Выберите сотрудников для доступа.');
        })
        .catch(function(err) {
          setStatus('Ошибка: ' + (err && err.message ? err.message : 'не удалось загрузить пользователей'));
        });
      return;
    }
    $b24.callMethod('app.info', {}, function(appInfo) {
      $b24.callMethod('user.current', {}, function(userInfo) {
        const auth = Object.assign({}, appInfo, userInfo);
        authData = auth;
        setStatus('Получение списка сотрудников...');
        apiPost('/session/start', { auth: authData }).then(function(r){ return parseJsonOrThrow(r); })
          .then(function(session) {
            portalToken = session.portal_token;
            portalId = session.portal_id;
            return Promise.all([loadUsers(), loadAccessUsers()]);
          })
          .then(function(all) {
            const usersResp = all[0] || {};
            const accessResp = all[1] || {};
            allUsers = usersResp.users || [];
            accessUserIds = new Set((accessResp.user_ids || []).map(function(id){ return String(id); }));
            setStepUsers(true);
            renderUsers('');
            setStatus('Выберите сотрудников для доступа.');
          })
          .catch(function(err) {
            setStatus('Ошибка: ' + (err && err.message ? err.message : 'не удалось загрузить пользователей'));
          });
      });
    });
  }

  function init() {
    if (window.BX24 && typeof window.BX24.init === 'function') {
      window.BX24.init(function() {
        initWithBx24(window.BX24);
      });
      return;
    }
    if (window.B24Js && typeof window.B24Js.initializeB24Frame === 'function') {
      window.B24Js.initializeB24Frame()
        .then(function(b24) {
          initWithBx24(b24);
        })
        .catch(function() {
          setStatus('BX24 SDK не доступен');
        });
      return;
    }
    setStatus('BX24 SDK не доступен');
  }

  btnInstall.addEventListener('click', function() {
    const selectedIds = Array.from(userList.querySelectorAll('.user-cb:checked')).map(function(cb){ return parseInt(cb.getAttribute('data-id'), 10); });
    if (!selectedIds.length) return;
    btnInstall.disabled = true;
    setStatus('Сохраняем доступ...');
    saveAccessUsers(selectedIds)
      .then(function(r) { return parseJsonOrThrow(r); })
      .then(function() {
        document.getElementById('install-steps').style.display = 'block';
        setStepText('step-allowlist', 'Шаг 1: Доступ сохранён — ok', true);
        setStepText('step-bot', 'Шаг 2: Чат создаётся — ожидание');
        setStepText('step-ping', 'Шаг 3: Ping/pong — ожидание');
        setStatus('Запускаем создание чатов...');
        return finalizeProvision(selectedIds);
      })
      .then(function(res) {
        const data = res.data || {};
        const okCount = data.ok_count || 0;
        const failed = data.failed || [];
        if (failed.length) {
          setStepText('step-bot', 'Шаг 2: Чат создан — есть ошибки', false);
        } else {
          setStepText('step-bot', 'Шаг 2: Чат создан — ok', true);
        }
        setStepText('step-ping', 'Шаг 3: Ping/pong — ok', true);
        renderUserStatuses(failed, base);
        setStatus('Готово. Можно закрыть окно установки.');
        btnRetry.style.display = failed.length ? 'inline-block' : 'none';
        callInstallFinish().catch(function(){});
      })
      .catch(function(err) {
        setStatus('Ошибка: ' + (err && err.message ? err.message : 'не удалось завершить')); 
        btnInstall.disabled = false;
      });
  });

  btnRetry.addEventListener('click', function() {
    btnRetry.style.display = 'none';
    btnInstall.click();
  });

  init();
})();
  </script>
</body>
</html>
