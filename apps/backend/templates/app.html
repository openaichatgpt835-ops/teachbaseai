<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Teachbase AI — Статус</title>
  <script src="https://unpkg.com/@bitrix24/b24jssdk@latest/dist/umd/index.min.js"></script>
  <style>
    :root {
      --ink: #0f172a;
      --muted: #64748b;
      --accent: #2563eb;
      --bg: #f3f6ff;
      --card: #ffffff;
      --border: #e2e8f0;
      --shadow: 0 16px 36px rgba(15, 23, 42, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Manrope', 'Inter', system-ui, -apple-system, Segoe UI, sans-serif;
      color: var(--ink);
      background: radial-gradient(circle at 10% 10%, #f2f7ff 0%, #f8fbff 45%, #ffffff 100%);
      user-select: none;
    }
    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 28px 20px 40px;
    }
    h1 { margin: 0 0 8px; font-size: 26px; }
    .status { padding: 10px 12px; border-radius: 12px; font-size: 12px; margin: 10px 0; }
    .pending { background: #fff7ed; color: #9a3412; border: 1px solid #fed7aa; }
    .err { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    .ok { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      box-shadow: var(--shadow);
    }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 13px; }
    th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #eef2ff; }
    th { color: var(--muted); font-weight: 600; }
    .btn { border: none; border-radius: 12px; padding: 10px 14px; background: var(--accent); color: #fff; font-size: 12px; font-weight: 600; cursor: pointer; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-secondary { background: #e2e8f0; color: #1f2937; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
    .muted { color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Teachbase AI — Статус</h1>
    <div id="status" class="status pending">Загрузка...</div>
    <div id="content" style="display:none;">
      <div class="card">
        <table>
          <tbody>
            <tr><th>Домен портала</th><td id="domain">—</td></tr>
            <tr><th>Статус бота</th><td id="bot-status">—</td></tr>
            <tr><th>bot_id</th><td id="bot-id">—</td></tr>
            <tr><th>CODE</th><td id="bot-code">—</td></tr>
          </tbody>
        </table>
        <h3 style="margin:16px 0 6px;">Allowlist</h3>
        <table id="allowlist-table">
          <thead><tr><th>Имя</th><th>user_id</th></tr></thead>
          <tbody id="allowlist-body"></tbody>
        </table>
        <h3 style="margin:16px 0 6px;">Статистика (MVP)</h3>
        <div id="stats" class="muted">—</div>
        <div class="actions">
          <button id="btn-allowlist" class="btn">Изменить allowlist</button>
          <button id="btn-provision" class="btn btn-secondary">Повторить provision</button>
          <button id="btn-bot-check" class="btn btn-secondary">Проверить бота</button>
        </div>
      </div>
    </div>
  </div>
  <script>
(function() {
  const base = window.location.origin;
  const status = document.getElementById('status');
  const content = document.getElementById('content');

  function setStatus(cls, text) {
    status.className = 'status ' + cls;
    status.textContent = text;
  }

  function apiPost(path, body) {
    return fetch(base + '/api/v1/bitrix' + path.replace(/^\/v1\/bitrix/, ''), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
      body: JSON.stringify(body || {})
    });
  }

  function loadStatus(auth) {
    return apiPost('/app/status', { auth: auth }).then(function(r) {
      if (r.status === 404 || r.status === 403) return null;
      if (!r.ok) return null;
      return r.json();
    });
  }

  function render(data) {
    if (!data || data.installed === false) {
      window.location.href = base + '/api/v1/bitrix/install';
      return;
    }
    document.getElementById('domain').textContent = data.domain || '—';
    document.getElementById('bot-status').textContent = data.bot_status || '—';
    document.getElementById('bot-id').textContent = data.bot_id != null ? data.bot_id : '—';
    document.getElementById('bot-code').textContent = data.bot_code || '—';
    const tbody = document.getElementById('allowlist-body');
    tbody.innerHTML = '';
    (data.allowlist || []).forEach(function(row) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td>' + (row.name || '—') + '</td><td>' + (row.user_id ?? '—') + '</td>';
      tbody.appendChild(tr);
    });
    const stats = data.stats || {};
    document.getElementById('stats').textContent = [
      stats.in_24h != null ? 'Входящих (24ч): ' + stats.in_24h : '',
      stats.out_24h != null ? 'Исходящих (24ч): ' + stats.out_24h : '',
      stats.blocked_24h != null ? 'Заблокировано (24ч): ' + stats.blocked_24h : ''
    ].filter(Boolean).join(' | ') || '—';
    content.style.display = 'block';
    setStatus('ok', 'Готово');
  }

  document.getElementById('btn-allowlist').addEventListener('click', function() {
    window.location.href = base + '/api/v1/bitrix/install';
  });

  document.getElementById('btn-provision').addEventListener('click', function() {
    const btn = this;
    btn.disabled = true;
    const auth = window._lastAuth;
    if (!auth) { btn.disabled = false; return; }
    apiPost('/app/provision', { auth: auth }).then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
      .then(function(out) {
        btn.disabled = false;
        if (!out.ok) {
          setStatus('err', (out.data && out.data.detail) || 'Ошибка');
          return;
        }
        setStatus('ok', 'Provision OK');
      })
      .catch(function() {
        btn.disabled = false;
        setStatus('err', 'Ошибка');
      });
  });

  document.getElementById('btn-bot-check').addEventListener('click', function() {
    const btn = this;
    btn.disabled = true;
    const auth = window._lastAuth;
    if (!auth) { btn.disabled = false; return; }
    apiPost('/app/bot-check', { auth: auth }).then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
      .then(function(out) {
        btn.disabled = false;
        if (!out.ok) {
          setStatus('err', (out.data && out.data.detail) || 'Ошибка');
          return;
        }
        setStatus('ok', 'Bot OK');
      })
      .catch(function() {
        btn.disabled = false;
        setStatus('err', 'Ошибка');
      });
  });

  function init() {
    if (!window.BX24) {
      setStatus('err', 'BX24 SDK не доступен');
      return;
    }
    window.BX24.init(function() {
      window.BX24.callMethod('app.info', {}, function(appInfo) {
        window.BX24.callMethod('user.current', {}, function(userInfo) {
          const auth = Object.assign({}, appInfo, userInfo);
          window._lastAuth = auth;
          loadStatus(auth)
            .then(function(data) { render(data); })
            .catch(function() { setStatus('err', 'Ошибка'); });
        });
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
  </script>
</body>
</html>
