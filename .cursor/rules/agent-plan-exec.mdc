---
description: Agent rules — PLAN→EXEC, no user questions, deploy to prod, DoD, security, Bitrix
alwaysApply: true
---

# Правила для агента (PLAN→EXEC, без вопросов пользователю)

> Эти правила обязательны для каждого этапа и каждого изменения.  
> Пользователь ничего не делает руками: ни CLI, ни curl, ни "переустанови", ни "зайди проверь". Всё выполняет агент.

---

## 0) Режим работы и ответственность
- **РЕЖИМ: PLAN→EXEC.** Сначала краткий план/дизайн (модули/эндпоинты/таблицы/потоки/риски), затем реализация.
- **Вопросов пользователю не задавать.** Любую неоднозначность решай дефолтом и фиксируй в `docs/ARCHITECTURE.md`.
- Любое состояние/ошибка/изменение обязано быть видно через UI/эндпоинты (не через "посмотри в консоли").

---

## 1) Среда и деплой (жёстко)
- **В конце КАЖДОГО этапа: деплой на сервер 109.73.193.61** через docker compose (prod).
- **Админка не должна торчать наружу.** По дефолту:
  - admin UI и admin API слушают **localhost** на сервере
  - доступ к админке только через **SSH‑туннель (PuTTY)**
- Наружу публикуем только необходимые **публичные** endpoints (Bitrix OAuth callback / приём событий) через nginx/HTTPS.
- В проде обязательно: healthchecks, auto-restart, log rotation, закрытые внутренние порты/сервисы.

---

## 2) Definition of Done (DoD) — стоп‑критерий
Этап считается выполненным ТОЛЬКО если выполнено всё:
1) **Тесты**: unit + integration + e2e sanity (через внутренние test/debug endpoints)
2) **Миграции БД**: применены или зафиксировано "не требуется"
3) **Деплой на 109.73.193.61**
4) **Проверки после деплоя** (агент делает сам):
   - `GET /health` → 200
   - `GET /ready` → 200
   - ключевые admin‑страницы/эндпоинты доступны через SSH‑туннель
5) **Наблюдаемость**: статус/ошибки/очередь/логи доступны из UI/эндпоинтов
- Если DoD не выполнен — агент чинит до выполнения, а не наращивает функционал.

---

## 3) Управление изменениями
- Изменения делать **минимально‑инвазивными**:
  - не переписывать полпроекта "заодно"
  - не менять DTO/API без причины
  - не делать массовых переименований
- Если нужен рефактор — это **отдельный этап** с отдельным DoD и тестами.
- Любой шаг, который может сломать прод, должен быть "защитным" (флаги, обратная совместимость, миграции).

---

## 4) Структура кода и лимит размера файлов
- Запрещены монолиты: **никаких giant main.py** и "всё в одном файле".
- **Файлы кода <300–500 строк**. Если больше — делить на модули.
- Обязательное разделение слоёв:
  - `api/routers` (тонкие контроллеры)
  - `schemas` (DTO/Pydantic/TS types)
  - `services` (бизнес‑логика)
  - `clients` (внешние интеграции)
  - `repos` (доступ к БД)
  - `models` (ORM)
  - `jobs` (очереди/воркеры)
  - `settings` (env→config)
  - `utils` (общие помощники)
- Единые точки входа:
  - один клиент для Bitrix (все REST вызовы только через него)
  - единый логгер (json), единые ошибки (error contract)

---

## 5) Конфигурация и зависимости
- Все зависимости фиксировать lock‑файлами:
  - Python: pinned зависимости (poetry.lock/requirements.txt)
  - Node: lock (package-lock/pnpm-lock)
- Обязательны:
  - `.env.example` (полный список переменных)
  - документация env в `docs/ONBOARDING.md`
- Поведение:
  - dev стартует с безопасными дефолтами
  - prod падает с понятной ошибкой, если критичные env не заданы
- Запрещены runtime‑вызовы наружу "просто так" (только целевые интеграции).

---

## 6) Безопасность
- Разделение поверхностей:
  - `/v1/admin/*` — только **admin JWT**
  - `/v1/bitrix/*` — подпись/секрет/OAuth‑контекст Bitrix
  - `/v1/portal/*` (Bitrix placement UI) — авторизация через Bitrix контекст + привязка к portal
- Debug endpoints:
  - включаются только `DEBUG_ENDPOINTS_ENABLED=1`
  - доступны только admin роли
- Секреты никогда не выводить: ни в UI, ни в логах, ни в ответах API.

---

## 7) Политика секретов и логов
- Логи только структурированные (json). Никакого лог‑спама (rate‑limit логов).
- Любые чувствительные данные маскировать:
  - `***` + последние 4 символа (если нужно)
- "Tail логов" в UI:
  - только whitelist источников (backend/worker/nginx)
  - маскирование секретов по паттернам (Bearer, apikey, secret, password, token)
  - ограничение объёма (tail=200) и частоты запросов
  - доступ только админам

---

## 7a) Кириллица и кодировки (обязательно)
- Во всех отчётах, UI и сообщениях **кириллица должна отображаться корректно** (без "????" и "Р…").
- Исходники, шаблоны и документы сохранять в UTF‑8.
- Любые строки пользовательского интерфейса — на кириллице.

---

## 8) База данных и миграции (только Alembic)
- Любые изменения схемы БД — **только миграциями Alembic**.
- Запрещено:
  - `create_all()` в проде
  - "ручные SQL миграции" без Alembic
- Для больших таблиц:
  - индексы/партиции готовятся миграциями
  - включаются только флагом, по умолчанию выключены

---

## 9) Очереди/воркеры (предохранители и SLA)
- Любая задача обязана иметь:
  - timeout
  - max retries
  - backoff + jitter
  - финальный failed/DLQ‑статус (виден в UI)
- Worker heartbeat обязателен (UI показывает "жив/не жив").
- Любая задача должна быть идемпотентной (повтор не создаёт дубль tx).

---

## 10) Надёжность message‑flow
- Никаких UnboundLocalError: не использовать переменные вне ветки определения.
- Никаких бесконечных циклов без sleep/backoff/jitter.
- Setup/инициализация — **идемпотентны** + отдельный diagnostics + attempt‑fix.
- Дедуп входящих событий по стабильному ключу (например `portal_id + provider_message_id/event_id`).
- Outbox pattern обязателен: запись → отправка → статус/ретраи.
- Политика ответа:
  - по умолчанию **1 входящее сообщение → максимум 1 исходящий ответ**
  - multi‑reply допускается только как отдельная стратегия с явной реализацией и событиями

---

## 11) Bitrix24 Cloud / Marketplace
- Интеграция строго: **OAuth + placement + event.bind**.
- Мультипортальность:
  - у каждого портала свой admin, токены, настройки, лимиты
  - десятки пользователей на портал
  - portal admin выбирает кому доступен чат + загружает KB
- Приватные чаты:
  - приложение создаёт приватный чат/диалог для разрешённых пользователей (идемпотентно)
- История переписки и диагностика:
  - dialogs/messages/events/outbox храним у себя
- Нормализация идентификаторов Bitrix:
  - хранить `raw` и `canonical`
  - отправка только по canonical provider_dialog_id
  - ошибки отправки всегда фиксируются в outbox и видны в UI
- Важно: если нет валидного PUBLIC_BASE_URL/HTTPS — система не ломается, показывает статус "ожидается публичный URL", но локальные/внутренние e2e сценарии (симулятор) обязаны работать.

---

## 11a) Bitrix24: источник истины
- **Источник истины по Bitrix24:** `docs/BITRIX_DOCS_INDEX.md`
- Перед любыми изменениями Bitrix24‑интеграции: сначала свериться с `docs/BITRIX_DOCS_INDEX.md`, затем с кодом.
- Если в доке нет ответа — зафиксировать гипотезу и добавить примечание/ссылку в `docs/BITRIX_DOCS_INDEX.md` (или отдельный раздел «Примечания проекта»), не фантазировать.
- Не добавлять домены порталов/токены/секреты в документацию.

---

## 12) API и эндпоинты
- "Отдельный endpoint на каждый важный элемент", но не на каждую кнопку.
- Каждая UI‑кнопка должна дергать конкретный endpoint.
- Версионирование: `/v1/...`
- Контракты DTO типизированы, ошибки унифицированы (единый формат ошибок).

---

## 13) Тестирование (обязательный минимум)
- Backend: pytest
  - unit: rate limiter, normalizer, dedup, outbox transitions, billing counters
  - integration: postgres+redis+queue
- Frontend: vitest + минимальный e2e (playwright smoke)
- Обязательный e2e sanity (через внутренний endpoint), без внешнего Bitrix:
  - "симулируем входящее → rx → dialog → tx → send_ok → видно в админке"

---

## 14) Документация
В каждом этапе обновлять:
- `docs/ARCHITECTURE.md` — модули, таблицы, потоки, ключевые решения/дефолты
- `docs/ONBOARDING.md` — dev/prod, env, как смотреть статусы/логи в админке
- `docs/OPERATIONS.md` — runbook: "не отвечаем", "429", "токен умер", "очередь растёт"
- `docs/BITRIX_INSTALL.md` — инструкция пользователю Bitrix24:
  - установка приложения (Marketplace/локально для тестов)
  - необходимые права
  - первый запуск и что происходит автоматически
  - выбор пользователей, кому доступен чат
  - загрузка KB, переиндексация
  - проверка ping/pong
  - тиражирование на новый портал
  - типовые ошибки и кнопка auto‑fix

---

## 15) Отчёт по итогу этапа
Агент всегда выдаёт:
- Что сделано (по DoD чек‑листу)
- Как проверить (только UI/эндпоинты, без действий пользователя)
- Результаты тестов (кратко)
- Результаты деплоя на 109.73.193.61 (кратко)
- Статус миграций БД: применены / не требуются
- Список созданных/изменённых файлов
- Текст коммита + список файлов для коммита (git операции делает пользователь вручную)
